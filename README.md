# Road Detector Go Microservice

Микросервис на Go для анализа дорожной разметки. Выполняет географические вычисления и обращается к Python FastAPI сервису для анализа нейронной сетью.

## Архитектура

Микросервис состоит из следующих компонентов:

- **Handler** - HTTP обработчики для REST API
- **Service** - Бизнес-логика анализа дорожной разметки
- **Client** - HTTP клиент для взаимодействия с Python API
- **Geo** - Географические вычисления (расстояния, интерполяция, сегментация)
- **Config** - Конфигурация приложения
- **Models** - Модели данных

## API Endpoints

### POST /api/v1/analyze
Анализирует дорожную разметку на видео.

**Параметры (multipart/form-data):**
- `video` (file, обязательный) - Видео файл для анализа
- `startLat` (number, обязательный) - Широта начальной точки (-90 до 90)
- `startLon` (number, обязательный) - Долгота начальной точки (-180 до 180)
- `endLat` (number, обязательный) - Широта конечной точки (-90 до 90)
- `endLon` (number, обязательный) - Долгота конечной точки (-180 до 180)
- `segmentLength` (integer, опциональный) - Длина сегмента в метрах (50-1000, по умолчанию 100)

**Ответ:**
```json
{
  "status": "success",
  "message": "Анализ дорожной разметки успешно завершен",
  "overall_stats": {
    "total_frames": 1500,
    "total_distance_meters": 2500.75,
    "segment_length_meters": 100,
    "total_segments": 25,
    "segments_with_data": 23,
    "average_coverage": 85.6
  },
  "segments": [
    {
      "segment_id": 1,
      "frames_count": 60,
      "coverage_percentage": 90.0,
      "start_coordinate": {"lat": 55.7558, "lon": 37.6176},
      "end_coordinate": {"lat": 55.7568, "lon": 37.6186},
      "has_data": true
    }
  ]
}
```

### GET /health
Проверяет состояние сервиса и его зависимостей.

**Ответ:**
```json
{
  "status": "healthy",
  "model_loaded": true,
  "version": "1.0.0"
}
```

## Конфигурация

Конфигурация через переменные окружения:

- `SERVER_PORT` - Порт сервера (по умолчанию: 8080)
- `PYTHON_API_BASE_URL` - URL Python API (по умолчанию: http://localhost:8000)
- `PYTHON_API_TIMEOUT_SECONDS` - Таймаут для Python API (по умолчанию: 300)
- `LOG_LEVEL` - Уровень логирования (debug, info, warn, error, по умолчанию: info)

## Запуск

### Локальный запуск

1. Убедитесь, что Python FastAPI сервис запущен на порту 8000
2. Установите зависимости:
```bash
go mod download
```

3. Запустите сервис:
```bash
go run cmd/server/main.go
```

### Docker

```bash
docker build -t road-detector-go .
docker run -p 8080:8080 \
  -e PYTHON_API_BASE_URL=http://host.docker.internal:8000 \
  road-detector-go
```

### Docker Compose

```bash
# Из корневой директории проекта
docker-compose up --build
```

## Разработка

### Структура проекта

```
road-detector-go/
├── cmd/server/          # Точка входа приложения
├── internal/
│   ├── client/          # HTTP клиенты
│   ├── config/          # Конфигурация
│   ├── geo/             # Географические вычисления
│   ├── handler/         # HTTP обработчики
│   └── service/         # Бизнес-логика
├── pkg/models/          # Модели данных
├── go.mod
├── go.sum
├── Dockerfile
└── README.md
```

### Зависимости

- **Gin** - HTTP веб-фреймворк
- **Logrus** - Структурированное логирование
- **Стандартные библиотеки Go** - HTTP клиент, математические вычисления

## Алгоритм работы

1. **Получение запроса** - Принимает видео и координаты маршрута
2. **Вызов Python API** - Отправляет видео на анализ нейронной сетью
3. **Интерполяция координат** - Вычисляет координаты для каждого кадра видео
4. **Сегментация маршрута** - Разбивает маршрут на сегменты заданной длины
5. **Анализ покрытия** - Вычисляет процент покрытия разметкой для каждого сегмента
6. **Формирование ответа** - Возвращает общую статистику и данные по сегментам

## Географические вычисления

Используется формула гаверсинуса для точного вычисления расстояний между географическими координатами. Координаты интерполируются линейно между начальной и конечной точками маршрута.

## Логирование

Микросервис поддерживает структурированное логирование с различными уровнями:
- **Debug** - Подробная отладочная информация
- **Info** - Общая информация о работе сервиса
- **Warn** - Предупреждения
- **Error** - Ошибки

В продакшене логи выводятся в формате JSON для удобства анализа. 